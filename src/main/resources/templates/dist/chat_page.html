
<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    
    <meta name="x5-fullscreen" content="true">
    
    <meta name="fullscreen" content="yes">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
    <meta name="keywords" content="智能在线客服系统"/>
    <meta name="description" content="智能在线客服系统"/>
    <title>超级管理员</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/element-ui/2.15.1/theme-chalk/index.min.css">
    <script src="https://cdn.staticfile.org/vue/2.6.11/vue.min.js"></script>
    <script src="https://cdn.staticfile.org/element-ui/2.15.1/index.js"></script>
    <script src="https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js"></script>

    <script src="/static/js/functions.js?v=0.6.6"></script>
    <link rel="stylesheet" href="/static/css/front.css?v=0.6.0" />
    <link rel="stylesheet" href="/static/css/common.css?v=0.6.7" />
    <link rel="stylesheet" href="/static/css/icono.min.css" />
    <link rel="icon" href="/static/images/favicon.ico">
    <style>
        .el-message-box{
            width: auto;
            max-width: 100%;
            max-height: 100%;
            overflow: auto;
        }
        .visitorEditorArea  textarea {
            padding: 7px 0 7px 8px;
            font-size:16px;
            line-height: 21px;
        }
        .change-rebot {
          color: #07a9fe;
          text-decoration: none;
          cursor: pointer;
        }
    </style>
</head>
<body>
<div id="app"  class="chatCenter">
    <template>
        
        <div class="chatEntTitle" v-show="!isIframe">
            <el-badge :type="onlineType" is-dot class="item">
                <el-avatar class="chatEntTitleLogo" :size="35" :src="noticeAvatar"></el-avatar>
            </el-badge>
            <span>&lt;{chatTitle}></span>
        </div>
        <div class="chatEntBox">
            <div  ref="chatVisitorPage" id="chatVisitorPage" class="chatContext chatVisitorPage" v-on:click="showIconBtns=false;showFaceIcon=false">
                <div class="chatBox">
                    <div style="cursor: pointer" class="chatTime" v-on:click="loadMoreMessages" v-show="showLoadMore">&lt;{flyLang.moremessage}></div>

                    <el-row class="chatReplay" :gutter="2" v-show="replys.length>0">
                        <el-col :span="3"><el-avatar shape="square" :size="36" :src="noticeAvatar"></el-avatar></el-col>
                        <el-col :span="21">
                            <div class="chatUser">&lt;{noticeName}></div>
                            <div class="chatContent visitorReply" >
                                <div v-for="reply in replys">
                                    <div class="visitorReplyTitle">&lt;{reply.group_name}></div>
                                    <div v-on:click="sendReply(item.item_name)" class="visitorReplyContent" v-for="item in reply.items">&lt;{item.item_name}></div>
                                </div>
                            </div>
                        </el-col>
                        <div class="clear"></div>
                    </el-row>
                    <el-dialog
                            :title="flyLang.leave"
                            :visible.sync="allOffline"
                            width="100%"
                            top="0">
                        <el-input style="margin-bottom: 10px;" :placeholder="flyLang.email"  v-model="visitorContact.email"></el-input>
                        <el-input style="margin-bottom: 10px;" :placeholder="flyLang.wechat"  v-model="visitorContact.weixin"></el-input>
                        <el-input style="margin-bottom: 10px;" :placeholder="flyLang.realname"  v-model="visitorContact.name"></el-input>
                        <el-input :placeholder="flyLang.content" type="textarea"  v-model="visitorContact.msg"></el-input>
                        <span slot="footer" class="dialog-footer">
                        <el-button @click="sendEmailMsg">&lt;{flyLang.sent}></el-button>
                        <el-button @click="allOffline = false">&lt;{flyLang.cancel}></el-button>
                    </span>
                    </el-dialog>
                    
                    <el-dialog
                            :visible.sync="audioDialog"
                            width="100%"
                            top="0">
                        <div class="dialogRecoder">
                            <el-progress type="circle" :format="recoderFormat" :stroke-width="10" :percentage="recoderSecond"></el-progress>
                            <br/>
                            <audio v-show="recorderEnd" controls ref="audio" muted="muted" src="" id="audio"></audio>
                            <br/>
                            <el-button id="start" @click="startRecoder($event)">&lt;{flyLang.start}></el-button>
                            <el-button @click="stopRecoder($event)">&lt;{flyLang.stop}></el-button>
                            <el-button @click="sendRecoder()">&lt;{flyLang.sent}></el-button>
                            <el-button @click="cancelRecoder()">&lt;{flyLang.cancel}></el-button>
                        </div>

                    </el-dialog>
                    
                    
                    <el-dialog
                            :visible.sync="flagsDialog"
                            width="90%"
                            top="30px">
                        <el-button @click="selectLang('cn')" class="flagBtn" type="primary" plain><img src="/static/images/flags/cn.svg"/> 中文</el-button>
                        <el-button @click="selectLang('en')" class="flagBtn" type="primary" plain><img src="/static/images/flags/gb.svg"/> english</el-button>
                        <el-button @click="selectLang('jp')" class="flagBtn" type="primary" plain><img src="/static/images/flags/jp.svg"/> Japanese</el-button>
                    </el-dialog>
                    

                    <el-row :gutter="2" v-for="v in msgList" v-bind:class="{'chatBoxMe': v.is_kefu==true}">
                        <div class="chatTime" v-bind:class="{'chatTimeHide': v.show_time==false}"><span>&lt;{v.time}></span></div>
                        <div v-if="v.is_kefu!=true">
                            <el-col :span="3"><el-avatar shape="square" :size="36" :src="v.avator"></el-avatar></el-col>
                            <el-col :span="21">
                                <div class="chatUser"  v-if="showKefuName!='off'">&lt;{v.name}></div>
                                <div class="chatContent replyContentBtn" v-html="v.content"></div>
                            </el-col>
                        </div>
                        <div class="kefuMe" v-if="v.is_kefu==true">
                            <el-col :span="24">
                                <div class="chatContent replyContentBtn" v-html="v.content"></div>
                                <div class="chatReadStatus">&lt;{v.read_status}></div>
                            </el-col>
                        </div>
                        <div class="clear"></div>
                    </el-row>

                    
                    
                </div>
            </div>
            <div class="chatBoxSend">
                <div class="hotQuestion">
                    <a
                            v-for="item in hotQuestion"
                            v-on:click="messageContent=item;chatToUser()">
                        &lt;{item}>
                    </a>
                </div>
                <div class="iconBtns visitorIconBox" v-show="showIconBtns">
                    <div style="display: none" :title="flyLang.emotions" class="icono-smile visitorIconBtns visitorFaceBtn"></div>
                    <div :title="flyLang.photo" class="icono-image visitorIconBtns visitorImageBtn" id="uploadImg" v-on:click="uploadImg('/uploadimg')"></div>
                    <div :title="flyLang.file" class="icono-folder visitorIconBtns visitorFolderBtn" id="uploadFile" v-on:click="uploadFile('/uploadfile')"></div>
                    <div :title="flyLang.recoder" class="icono-microphone visitorIconBtns visitorHistoryBtn"  v-on:click="audioDialog=true"></div>
                    <div style="transform:rotate(-45deg) scale(0.78);" class="icono-pin"  v-on:click="qqMap==true?qqMap=false:qqMap=true;"></div>
                    <div :title="flyLang.newWindow" class="icono-display visitorIconBtns visitorHistoryBtn"  v-on:click="openNewWindow()"></div>
                    <div style="display:none;" class="audioIcon visitorIconBtns visitorAudioIcon"  @click="callPeer" ></div>
                    <div class="icono-support visitorIconBtns" @click="flagsDialog='true'"> </div>
                    <div class="clear"></div>
                </div>
                <div class="faceBox visitorFaceBox" v-if="showFaceIcon">
                    <ul class="faceBoxList">
                        <li v-on:click="faceIconClick(i)" class="faceIcon" v-for="(v,i) in face"  :title="v.name"><img :src=v.path></li>
                    </ul>
                    <div class="clear"></div>
                </div>
                <div class="visitorEditor">
                    <div  v-on:click="audioDialog==true?audioDialog=false:audioDialog=true" class="visitorEditorVoice visitorFaceBtn"></div>
                    <el-input :rows="1" type="textarea" resize="none" class="visitorEditorArea"  @focus="scrollBottom;showIconBtns=false" @blur="scrollBottom;showIconBtns=false" v-model="messageContent"  @keyup.native="inputNextText" v-on:keyup.enter.native="chatToUser">
                    </el-input>
                    <div :title="flyLang.emotions" v-on:click="showFaceIcon==true?showFaceIcon=false:showFaceIcon=true" class="visitorEditorSmile visitorFaceBtn"></div>
                    <div v-on:click="showIconBtns==true?showIconBtns=false:showIconBtns=true" v-show="messageContent==''" :title="flyLang.emotions" class="visitorEditorChoose"></div>
                    <el-button type="success" size="small" v-show="!sendDisabled && messageContent!=''" class="visitorEditorBtn"   :disabled="sendDisabled||messageContent==''" v-on:click="chatToUser();showIconBtns=false">&lt;{flyLang.sent}></el-button>
                </div>

                <div class="footContact clear">
                    <a href="" target="_blank">智能在线客服系统版权所有 © 2020-2022</a>
                </div>
            </div>
        </div>
        <div class="chatArticle">
            <div class="companyInfo">
                <el-avatar shape="square"  :size="160" :src="noticeAvatar"></el-avatar>
                <p>&lt;{noticeName}></p>
            </div>
            <div v-for="reply in replys">
                <a v-on:click="sendReply(item.item_name)" class="chatArticleItem" v-for="item in reply.items">&lt;{item.item_name}></a>
            </div>
        </div>
        <div class="clear"></div>

        
        <audio id="chatMessageAudio">
            <source id="chatMessageAudioSource"  />
        </audio>
        <audio id="chatMessageSendAudio">
            <source id="chatMessageSendAudioSource"  />
        </audio>
        <video id="chatRtc" style="display: none"></video>
        
        <el-dialog
                :visible.sync="reconnectDialog"
                :close-on-click-modal="false"
                width="90%"
                :show-close="false"
                top="50px" center>
            <span><i style="font-size: 20px;" class="el-icon-warning-outline"></i> &lt;{chatTitle}></span>
            <span slot="footer" class="dialog-footer">
                <el-button @click="focusHandle"  type="primary" plain>reconnect</el-button>
            </span>
        </el-dialog>
        
        

        <el-image
                style="display: none;"
                ref="preview"
                class="hideImgDiv"
                :src="imgPreviewSrc[0]"
                :preview-src-list="imgPreviewSrc"
                z-index="9999"
        ></el-image>


        
        <el-dialog
                :title="flyLang.visitorCommentTitle"
                :close-on-click-modal="false"
                :show-close="false"
                width="90%"
                :visible.sync="comment"
        >
            <div class="commentBox">
                <el-tooltip content="good" placement="top">
                    <span class="icono-smile" v-on:click="sendComment('good');comment = false"></span>
                </el-tooltip>
                <el-tooltip content="normal" placement="top">
                <span class="icono-meh" v-on:click="sendComment('normal');comment = false"></span>
                </el-tooltip>
                <el-tooltip content="bad" placement="top">
                <span class="icono-frown" v-on:click="sendComment('bad');comment = false"></span>
                </el-tooltip>
            </div>
            <span slot="footer" class="dialog-footer">

                    </span>
        </el-dialog>
        
        
        <iframe v-if="qqMap" style="position: fixed;top: 0;left: 0;z-index: 999999999" id="mapPage" width="100%" height="100%" frameborder=0
                src="https://apis.map.qq.com/tools/locpicker?search=1&type=1&key=
OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&referer=kefu">
        </iframe>
        


    </template>
</div>
</body>
<script src="/static/js/reconnecting-websocket.min.js"></script>
<script src="/static/js/recoder.js"></script>
<script>

    var KEFU_ID=getQuery('kefu_id');
    var REFER='http://' + window.location.host + '/setting_deploy';
    var ENT_ID=getQuery('ent_id');
    var IS_TRY='false';
    var VISITOR_ID='';
    var VISITOR_NAME='';
    var ERR_MSG='';
    var AVATOR='';
    var LANG=checkLang();
    var SHOW_KEFU_NAME=''
</script>
<script src="/static/js/chat-lang.js?v=0.5.1"></script>
<script src="/static/js/chat-config.js?v=0.5.1"></script>
<script>

    new Vue({
        el: '#app',
        delimiters:["<{","}>"],
        data: {
            window:window,
            server:getWsBaseUrl()+"/ws_visitor",
            socket:null,
            msgList:[],
            imgPreviewSrc:[
                "https://fuss10.elemecdn.com/8/27/f01c15bb73e1ef3793e64e6b7bbccjpeg.jpeg"],
            msgListNum:[],
            messageContent:"",
            chatTitle:GOFLY_LANG[LANG]['connecting'],
            visitor:{},
            face:emojiGifsMap(),
            showKfonline:false,
            socketClosed:false,
            focusSendConn:false,
            wsSocketClosed:true,
            timer:null,
            loadingTimer:null,
            sendDisabled:false,
            entLogo:"",
            entName:"",
            peer:null,
            peerjsId:"",
            kefuPeerId:"",
            loading:null,
            localStream:null,
            flyLang:GOFLY_LANG[LANG],
            lang:LANG,
            textareaFocused:false,
            replys:[],
            noticeName:"",
            noticeAvatar:"",
            allOffline:false,
            visitorContact:{
                email:"",
                weixin:"",
                name:"",
                msg:"",
            },
            haveUnreadMessage:false,
            audioDialog:false,
            flagsDialog:false,
            recorder:null,
            recorderAudio:null,
            recordeTimer:null,
            recoderSecond:0,
            currentActiveTime:Date.now(),
            timeoutTimer:null,
            timeoutLongTime:20*60*1000,
            allTimeouter:[],
            currentPage:1,
            showLoadMore:false,
            loadMoreDisable:false,
            websocketOpenNum:0,
            websocketMaxOpenNum:10,
            talkBtnText:"按住 说话",
            recorderEnd:false,
            isMobile:false,
            isIframe:false,
            onlineType:"success",
            reconnectDialog:false,
            showIconBtns:false,
            showFaceIcon:false,
            showKefuName:SHOW_KEFU_NAME,
            comment:false,
            qqMap:false,
            hotQuestion:[],
        },
        methods: {
          change() {
            var _this=this;
            this.sendAjax("/trans_kefu_front","get",{kefu_id:KEFU_ID,visitor_id:this.visitor.visitor_id, curKefuId: '100-kefu3'},function(result){
              _this.setCache('isRebot', true)
              _this.visitor.to_id = KEFU_ID
                setTimeout(() => {
                    this.socket.close();
                    _this.socketClosed=true;
                    _this.getUserInfo()
                },100)
            });
          },
            initConn:function(kefuId) {
                let id = kefuId?kefuId:this.visitor.to_id
                this.socket = new ReconnectingWebSocket(this.server+"?visitor_id="+this.visitor.visitor_id+"&to_id="+id);
                this.socket.debug = true;
                this.socket.onmessage = this.OnMessage;
                this.socket.onopen = this.OnOpen;
                this.socket.onerror = this.OnError;
                this.socket.onclose = this.OnClose;
            },
            OnOpen:function() {
                console.log("ws:onopen");
                
                if(this.websocketOpenNum>=this.websocketMaxOpenNum){
                    this.chatTitle=GOFLY_LANG[LANG]['refresh'];
                    setTimeout(() => {
                        this.socket.close();
                    },100)
                    return;
                }
                this.websocketOpenNum++;

                this.chatTitle=this.noticeName;
                this.checkTimeout();
                this.socketClosed=false;
                this.focusSendConn=false;
                this.wsSocketClosed=false;
                this.sendVisitorLogin();
                this.getExtendInfo();
                this.reconnectDialog=false;
            },
            OnMessage:function(e) {
                console.log("ws:onmessage");
                this.socketClosed=false;
                this.focusSendConn=false;
                const redata = JSON.parse(e.data);
                if (redata.type == "kfOnline") {
                    let msg = redata.data
                    if(this.showKfonline && this.visitor.to_id==msg.id){
                        return;
                    }
                    this.visitor.to_id=msg.id;
                    this.chatTitle=msg.name+","+GOFLY_LANG[LANG]['chating'];
                    $(".chatBox").append("<div class=\"chatTime\">"+this.chatTitle+"</div>");
                    this.scrollBottom();
                    this.showKfonline=true;
                }
                if (redata.type == "transfer") {
                    var kefuId = redata.data
                    if(!kefuId){
                        return;
                    }
                    this.visitor.to_id=kefuId;
                }
                if (redata.type == "comment") {
                    this.comment=true;
                }
                if (redata.type == "notice") {
                    let msg = redata.data
                    if(!msg){
                        return;
                    }
                    this.chatTitle=msg
                    $(".chatBox").append("<div class=\"chatTime\">"+this.chatTitle+"</div>");
                    this.scrollBottom();
                }
                if (redata.type == "peerid") {
                    let msg = redata.data;
                    if(!msg){
                        return;
                    }
                    this.kefuPeerId=msg;
                    this.talkPeer();
                }
                if (redata.type == "delete") {
                    var msg = redata.data;
                    for(var i=0;i<this.msgList.length;i++){
                        if(this.msgList[i].msg_id==msg.msg_id){
                            this.msgList.splice(i,1);
                            break;
                        }
                    }
                }
                if (redata.type == "read") {
                    var msg = redata.data;
                    for(var i=0;i<this.msgList.length;i++){
                        this.msgList[i].read_status=GOFLY_LANG[LANG]['read'];
                    }
                }
                if (redata.type == "message") {
                    let msg = redata.data
                    
                    var _this=this;

                    var msgArr=msg.content.split("[br]");
                    for(var i in msgArr){
                        let content = {}
                        content.avator = msg.avator;
                        content.name = msg.name;
                        content.content =replaceSpecialTag(msgArr[i]);
                        content.is_kefu = false;
                        content.time = msg.time;
                        content.is_reply=true;
                        content.msg_id = msg.msg_id;
                        this.msgList.push(content);
                        setTimeout(function () {
                            _this.scrollBottom();
                            // _this.change()
                        },200);
                    }

                    notify(msg.name, {
                        body: msg.content,
                        icon: msg.avator
                    },function(notification) {
                        window.focus();
                        notification.close();
                    });
                    
                    flashTitle();
                    
                    this.cleanAllTimeout();
                    this.alertSound('/static/images/alert4.mp3');
                    this.haveUnreadMessage=true;
                }
                if (redata.type == "close") {
                    this.showTitle(GOFLY_LANG[LANG]['closemes']);
                    this.scrollBottom();
                    this.socket.close();
                    
                    this.focusSendConn=true;
                    this.reconnectDialog=true;
                }
                if (redata.type == "force_close") {
                    this.showTitle(GOFLY_LANG[LANG]['forceclosemes']);
                    this.scrollBottom();
                    this.socket.close();
                    this.socketClosed=true;
                    this.reconnectDialog=true;
                }
                if (redata.type == "auto_close") {
                    this.showTitle(GOFLY_LANG[LANG]['autoclosemes']);
                    this.scrollBottom();
                    this.socket.close();
                    this.socketClosed=true;
                    this.reconnectDialog=true;
                }
                if (redata.type == "change_id") {
                    let msg = redata.data;
                    var openId=msg.to;
                    var visitor=this.getCache("visitor_"+ENT_ID);
                    visitor.visitor_id=openId;
                    this.setCache("visitor_"+ENT_ID,visitor);
                    location.reload();
                }
                window.parent.postMessage(redata,"*");
            },
            
            chatToUser:function() {
                if(this.sendDisabled){
                    return;
                }
                var messageContent=this.messageContent.trim("\r\n");
                messageContent=messageContent.replace("\n","");
                messageContent=messageContent.replace("\r\n","");
                if(messageContent==""||messageContent=="\r\n"){
                    this.messageContent="";
                    return;
                }
                this.messageContent=messageContent;
                this.currentActiveTime=Date.now();
                if(this.socketClosed){
                    setTimeout(() => {
                        this.initConn();
                    }, 100)
                }
                this.sendDisabled=true;
                let _this=this;

                let mes = {};
                mes.type = "visitor";
                mes.content = this.messageContent;
                mes.from_id = this.visitor.visitor_id;
                mes.to_id = this.visitor.to_id;
                mes.content = this.messageContent;
                $.post(BaseURL + "/2/message?lang="+getQuery("lang"),mes,function(res){
                    _this.sendDisabled=false;
                    if(res.code!=200){
                        _this.msgList.pop();
                        _this.$message({
                            message: res.msg,
                            type: 'error'
                        });
                        if(res.code==401){
                            setTimeout(function(){
                                window.location.reload();
                            },2000);
                        }
                        return;
                    }
                    let content = {}
                    content.avator=_this.visitor.avator;
                    content.content = replaceContent(res.data);
                    content.name = _this.visitor.name;
                    content.is_kefu = true;
                    content.read_status = GOFLY_LANG[LANG]['unread'];
                    content.time = _this.getNowDate();
                    content.show_time=false;
                    _this.msgList.push(content);
                    _this.scrollBottom();
                    _this.messageContent = "";
                    _this.cleanAllTimeout();
                    _this.sendSound();
                    _this.sendDisabled=false;
                });

            },
            
            inputNextText:function(){
                this.sendInputingStrNow(this.messageContent);
            },
            sendInputingStrNow:function(str){
                if(this.socketClosed||!this.socket||this.wsSocketClosed){
                    return;
                }
                var message = {}
                message.type = "inputing";
                message.data = {
                    from : this.visitor.visitor_id,
                    to : this.visitor.to_id,
                    content:str
                };
                this.socket.send(JSON.stringify(message));
            },
            sendVisitorLogin:function(){
                var _this=this;
                setTimeout(function(){
                    if(_this.socketClosed||!_this.socket||_this.wsSocketClosed){
                        return;
                    }
                    var message = {}
                    message.type = "visitor_login";
                    message.data = {
                        from : _this.visitor.visitor_id,
                        to : _this.visitor.to_id,
                    };
                    _this.socket.send(JSON.stringify(message));
                }, 3000);
            },
            OnClose:function(event) {
                console.log("ws:onclose",event);
                this.focusSendConn=true;
                this.wsSocketClosed=true;
                this.closeTimeoutTimer();
            },
            OnError:function(event) {
                console.log("ws:onerror",event);
                this.closeTimeoutTimer();
            },
            
            getUserInfo:function(){
                let obj=this.getCache("visitor_"+ENT_ID);
                var visitor_id=""
                var to_id=KEFU_ID;
                let entId = ENT_ID
                if(!this.getCache('isRebot')) {
                  to_id = '100-kefu3'
                  entId = '4'
                }
                if(obj){
                    visitor_id=obj.visitor_id;
                    
                }
                let _this=this;
                var extra=getQuery("extra");
                var url=getQuery("url");
                var paramVisitorId=VISITOR_ID;
                if(paramVisitorId!=""){
                    visitor_id=paramVisitorId;
                }
                var visitorName=VISITOR_NAME;
                var avator=AVATOR;

                if(extra==""){
                    var ext={};
                    var refer=document.referrer?document.referrer:"-";
                    ext.refer=refer;
                    ext.host=document.location.href;
                    extra=utf8ToB64(JSON.stringify(ext));
                }
                
                $.ajax({
                    type: "post",
                    url: BaseURL + "/visitor_login",
                    data:{dept_id:getQuery('dept_id'),visitor_id:visitor_id,visitor_name:visitorName,avator:avator,refer:REFER,to_id:to_id,extra:extra,ent_id:entId,url:url},
                    error:function(res){
                        var data=JSON.parse(res.responseText);
                        _this.$message({
                            message: data.msg,
                            type: 'error'
                        });
                    },
                    success: function(res) {
                        if(res.code!=200){
                            _this.$message({
                                message: res.msg,
                                type: 'error'
                            });
                            _this.chatTitle=res.msg;
                            _this.sendDisabled=true;
                            return;
                        }
                        if(res.alloffline){
                            _this.onlineType="danger";
                        }else{
                            _this.onlineType="success";
                        }
                        if(GOFLY_CONFIG.SHOW_OFFLINE_PAGE){
                            _this.allOffline=res.alloffline;
                        }
                        _this.sendDisabled=false;
                        res.result.visitor_id = visitor_id?visitor_id:res.result.visitor_id
                        _this.visitor=res.result;
                        _this.noticeName=res.kefu.username;
                        _this.noticeAvatar=res.kefu.avatar;
                        document.title=res.kefu.username;
                        _this.setCache("visitor_"+ENT_ID,res.result);
                        
                        _this.loadMoreMessages();
                        
                        setTimeout(() => {
                            _this.initConn();
                        },100)
                        
                        _this.ping();
                    }
                });

                
                
                
                
            },
            
            getMesssagesByVisitorId:function(isAll){
                let _this=this;
                $.ajax({
                    type:"get",
                    url:BaseURL + "/2/messages?visitor_id="+this.visitor.visitor_id,
                    success: function(data) {
                        if(data.code==200 && data.result!=null&&data.result.length!=0){
                            let msgList=data.result;
                            _this.msgList=[];
                            for(var i=0;i<msgList.length;i++){
                                let visitorMes=msgList[i];
                                let content = {}
                                if(visitorMes["mes_type"]=="kefu"){
                                    content.is_kefu = false;
                                }else{
                                    content.is_kefu = true;
                                }
                                content.avator = visitorMes["avator"];
                                content.name = visitorMes["name"];
                                content.content = replaceContent(visitorMes["content"]);
                                content.time = visitorMes["time"];
                                _this.msgList.push(content);
                                _this.scrollBottom();
                            }
                        }
                        if(data.code!=200){
                            _this.$message({
                                message: data.msg,
                                type: 'error'
                            });
                            _this.chatTitle=GOFLY_LANG[LANG]['refresh'];
                        }
                    }
                });
            },
            
            sendEmailMsg:function(){
                let _this=this;
                _this.visitorContact.ent_id=ENT_ID;
                $.ajax({
                    type:"post",
                    url:BaseURL + "/ent/email_message",
                    data:_this.visitorContact,
                    success: function(data) {
                        if(data.code!=200){
                            _this.$message({
                                message: data.msg,
                                type: 'error'
                            });
                        }else{
                            _this.allOffline=false;
                        }
                    }
                });
            },
            
            scrollBottom:function(){
                var _this=this;
                this.$nextTick(function(){
                    var container = _this.$el.querySelector(".chatVisitorPage");
                    container.scrollTop = 999999;
                    
                });
            },
            
            textareaFocus:function(){
                
                
                
                
                
                this.scrollBottom();
            },
            textareaBlur:function(){
                
                
                
                
                
                
                
                
                
                
                this.scrollBottom();
            },
            sendReply:function(title){
                var _this=this;

                let msg = {}
                msg.avator=_this.visitor.avator;
                msg.content = replaceContent(title);
                msg.name = _this.visitor.name;
                msg.is_kefu = true;
                msg.time = _this.getNowDate();
                msg.show_time=false;
                _this.msgList.push(msg);
                _this.scrollBottom();

                var mes = {};
                mes.content = title;
                mes.from_id = this.visitor.visitor_id;
                mes.ent_id = ENT_ID;
                _this.sendAjax("/2/message_ask","post",mes,function(msg){
                    var msgArr=msg.content.split("[b]");
                    for(var i in msgArr){
                        let content = {}
                        content.avator = msg.avator;
                        content.name = msg.name;
                        content.content =replaceSpecialTag(msgArr[i]);
                        content.is_kefu = false;
                        content.time = msg.time;
                        content.is_reply=true;
                        _this.msgList.push(content);
                        _this.scrollBottom();
                    }
                    _this.cleanAllTimeout();
                    _this.alertSound('/static/images/notification.mp3');
                });
                
            },
            
            getNowDate : function() {
                var d = new Date(new Date());
                return d.getFullYear() + '-' + this.digit(d.getMonth() + 1) + '-' + this.digit(d.getDate())
                    + ' ' + this.digit(d.getHours()) + ':' + this.digit(d.getMinutes()) + ':' + this.digit(d.getSeconds());
            },
            
            digit : function (num) {
                return num < 10 ? '0' + (num | 0) : num;
            },
            setCache : function (key,obj){
                if(navigator.cookieEnabled&&typeof window.localStorage !== 'undefined'){
                    localStorage.setItem(key, JSON.stringify(obj));
                }
            },getCache : function (key){
                if(navigator.cookieEnabled&&typeof window.localStorage !== 'undefined') {
                    return JSON.parse(localStorage.getItem(key));
                }
            },
            
            getNotice : function (){
                let _this=this;
                var noticed=this.getCache("noticed_"+ENT_ID);
                if(noticed){
                    return;
                }
                $.get(BaseURL + "/2/notices?visitor_id="+this.visitor.visitor_id+"&ent_id="+ENT_ID+"&kefu_name="+this.visitor.to_id,function(res) {
                    _this.setCache("noticed_"+ENT_ID,1);
                    
                    
                    
                    if (res.result.welcome != null) {
                        var msgs = res.result.welcome;
                        var delaySecond=0;
                        for(let i in msgs){
                            var msg=msgs[i];
                            if(msg.delay_second){
                                delaySecond+=msg.delay_second;
                            }else{
                                delaySecond+=4;
                            }
                            var timer =  setTimeout(function (msg) {
                                msg.time=_this.getNowDate();
                                msg.content = replaceSpecialTag(msg.content);
                                _this.msgList.push(msg);
                                _this.scrollBottom();
                                _this.alertSound('/static/images/notification.mp3');
                                var redata={
                                    type:"message",
                                    data:msg
                                }
                                window.parent.postMessage(redata,"*");
                            },1000*delaySecond,msg);
                            _this.allTimeouter.push(timer);
                        }
                    }
                });
            },
            initCss:function(){
                var _this=this;
                $(function () {
                    $("body").on("click",".replyContentBtn a",function() {
                        var txt=$(this).text();
                        var href=$(this).attr("href");
                        if(href=="self"||!href){
                            _this.sendReply(txt);
                            return false;
                        }
                    });
                    $("body").on("click",".replyContentBtn .change-rebot",function() {
                        _this.change()
                    });
                    $(window).resize(function(){
                        _this.visitorPageHeight();
                    });
                    if(isMobile()){
                        _this.visitorPageHeight();
                    }
                    $("body").on("click",".visitorReplyContent",function() {
                        var txt=$(this).text();
                        _this.messageContent=txt;
                        _this.chatToUser();
                    });
                });
            },
            
            ping:function(){
                let _this=this;
                let mes = {}
                mes.type = "ping";
                mes.data = "visitor:"+_this.visitor.visitor_id;
                setInterval(function () {
                    if(_this.socket!=null&&!_this.wsSocketClosed){
                        _this.socket.send(JSON.stringify(mes));
                    }
                },10000);
            },
            
            init:function(){
                var _this=this;
                _this.isMobile=isMobile();

                this.initCss();
                
                var ms= 1000*2;
                var lastClick = Date.now() - ms;
                $("body").mouseover(function(){
                    if(!_this.haveUnreadMessage){
                        return;
                    }
                    if (Date.now() - lastClick >= ms) {
                        lastClick = Date.now();
                        let params =  {
                          visitor_id: _this.visitor.visitor_id,
                          kefu: _this.visitor.to_id
                        }
                        $.ajax({
                          type:"post",
                          url:BaseURL + "/2/messages_read",
                          data:params,
                          success:function(data){
                            _this.haveUnreadMessage=false;
                          }
                        });
                    }
                });
                $('body').click(function(){
                    clearFlashTitle();
                    window.parent.postMessage({type:"focus"},"*");
                    
                    
                    try{
                        var selecter = window.getSelection().toString();
                        if (selecter != null && selecter.trim() != ""){
                            var str=selecter.trim();
                            _this.sendInputingStrNow(str);
                        }
                    } catch (err){
                        var selecter = document.selection.createRange();
                        var s = selecter.text;
                        if (s != null && s.trim() != ""){
                            var str=s.trim();
                            _this.sendInputingStrNow(str);
                        }
                    }
                });



                $("body").on("click",".chatImagePic",function() {
                    var url=$(this).attr("data-src");
                    _this.imgPreviewSrc=[url];
                    _this.$refs.preview.clickHandler();
                    
                    
                    
                    
                    return false;
                });
                window.onfocus = function () {
                    
                }
                var _hmt = _hmt || [];
                (function() {
                    var hm = document.createElement("script");
                    hm.src = "https://hm.baidu.com/hm.js?5dd2ee05dc1d1c33b36d4b6a9e0a1638";
                    var s = document.getElementsByTagName("script")[0];
                    s.parentNode.insertBefore(hm, s);
                })();

                
                if(self!=top){
                    _this.isIframe=true;
                }

            },
            
            faceIconClick:function(index){
                this.showFaceIcon=false;
                this.messageContent+="face"+this.face[index].name;
            },
            
            uploadImg:function (url){
                let _this=this;
                $('#uploadImg').after('<input type="file" accept="image/gif,image/jpeg,image/jpg,image/png" id="uploadImgFile" name="file" style="display:none" >');
                $("#uploadImgFile").click();
                $("#uploadImgFile").change(function (e) {
                    var formData = new FormData();
                    var file = $("#uploadImgFile")[0].files[0];
                    formData.append("imgfile",file); 
                    filter(file) && $.ajax({
                        url: BaseURL + url || '',
                        type: "post",
                        data: formData,
                        contentType: false,
                        processData: false,
                        dataType: 'JSON',
                        mimeType: "multipart/form-data",
                        success: function (res) {
                            if(res.code!=200){
                                _this.$message({
                                    message: res.msg,
                                    type: 'error'
                                });
                            }else{
                                _this.messageContent+='img[' + res.result.path + ']';
                                _this.chatToUser();
                            }
                        },
                        error: function (data) {
                            console.log(data);
                        }
                    });
                });
            },
            
            uploadFile:function (url){
                let _this=this;
                $('#uploadFile').after('<input type="file"  id="uploadRealFile" name="file2" style="display:none" >');
                $("#uploadRealFile").click();
                $("#uploadRealFile").change(function (e) {
                    var formData = new FormData();
                    var file = $("#uploadRealFile")[0].files[0];
                    formData.append("realfile",file); 
                    console.log(formData);
                    $.ajax({
                        url: BaseURL + url || '',
                        type: "post",
                        data: formData,
                        contentType: false,
                        processData: false,
                        dataType: 'JSON',
                        mimeType: "multipart/form-data",
                        success: function (res) {

                            if(res.code!=200){
                                _this.$message({
                                    message: res.msg,
                                    type: 'error'
                                });
                            }else{
                                _this.messageContent+='file[' + res.result.path + ']';
                                _this.chatToUser();
                            }
                        },
                        error: function (data) {
                            console.log(data);
                        }
                    });
                });
            },
            
            onPasteUpload:function(event){
                let items = event.clipboardData && event.clipboardData.items;
                let file = null
                if (items && items.length) {
                    
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            file = items[i].getAsFile()
                        }
                    }
                }
                if (!file) {
                    return;
                }
                let _this=this;
                var formData = new FormData();
                formData.append('imgfile', file);
                $.ajax({
                    url: BaseURL + '/uploadimg',
                    type: "post",
                    data: formData,
                    contentType: false,
                    processData: false,
                    dataType: 'JSON',
                    mimeType: "multipart/form-data",
                    success: function (res) {
                        if(res.code!=200){
                            _this.$message({
                                message: res.msg,
                                type: 'error'
                            });
                        }else{
                            _this.messageContent+='img[' + res.result.path + ']';
                            _this.chatToUser();
                        }
                    },
                    error: function (data) {
                        console.log(data);
                    }
                });
            },
            
            getTopQuestion:function(){
                var _this=this;
                $.get(BaseURL + "/other/getTopQuestion?ent_id="+ENT_ID,function(res) {
                    if(res.code!=200||!res.result){
                        return;
                    }
                    var hotQuestion=res.result.hotQuestion;
                    if(hotQuestion!=""){
                        _this.hotQuestion=hotQuestion.split(",");
                    }

                    var result=res.result.questionList;
                    if(result.length==0){
                        return;
                    }
                    var msg={};
                    msg.avator = _this.noticeAvatar;
                    msg.name = "";
                    msg.show_time = false;
                    msg.time = "";
                    msg.content="<div class='visitorReplyTitle'>我猜你想问？</div>";
                    for(key in result){
                        msg.content+="<div class='visitorReplyContent'>"+result[key]+"</div>"
                    }
                    _this.msgList.push(msg);
                    _this.scrollBottom();
                });
            },
            
            getAutoReply:function(){
                var _this=this;
                $.get(BaseURL + "/autoreply?ent_id="+ENT_ID,function(res) {
                    if(res.code!=200 || res.result.length==0){
                        return;
                    }
                    var result=res.result;
                    _this.replys.push(result);
                });
            },
            
            alertSound:function(soundUrl){
                var b = document.getElementById("chatMessageAudio");
                if (b.canPlayType('audio/ogg; codecs="vorbis"')) {
                    b.type= 'audio/mpeg';
                    b.src=soundUrl ;
                    var p = b.play();
                    p && p.then(function () {
                    }).catch(function (e) {
                    });
                }
            },
            sendSound:function(){
                var b = document.getElementById("chatMessageSendAudio");
                if (b.canPlayType('audio/ogg; codecs="vorbis"')) {
                    b.type= 'audio/mpeg';
                    b.src= '/static/images/sent.ogg';
                    var p = b.play();
                    p && p.then(function(){}).catch(function(e){});
                }
            },
            initPeerjs:function(){
                var peer = new Peer();
                this.peer=peer;
                var _this=this;

                peer.on('open', function(id) {
                    console.log('My peer ID is: ' + id);
                    _this.peerjsId=id;
                });
                peer.on('close', function() {
                    console.log('My peer close');
                    if(_this.loading!=null){
                        _this.loading.close();
                    }
                });
                peer.on('disconnected', function() {
                    console.log('My peer disconnected');
                    if(_this.loading!=null){
                        _this.loading.close();
                    }
                });
                peer.on('error', function() {
                    console.log('My peer error');
                    if(_this.loading!=null){
                        _this.loading.close();
                    }
                });
            },
            callPeer:function(){
                var _this=this;
                this.loading = this.$loading({
                    lock: true,
                    text: '正在请求通话',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                this.loadingTimer=setTimeout(function(){
                    _this.loading.close();
                }, 20000);

                var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                getUserMedia({video: false, audio: true}, function(stream) {
                    _this.localStream=stream;
                }, function(err) {
                    console.log('Failed to get local stream' ,err);
                });
                _this.sendAjax("/call_kefu","post",{kefu_id:_this.visitor.to_id,visitor_id:_this.visitor.visitor_id},function(result){
                });
            },
            talkPeer:function(){
                var remoteVideo = document.querySelector('video#chatRtc');
                var _this=this;
                if(this.loading!=null){
                    this.loading.close();
                }
                clearTimeout(this.loadingTimer);
                this.$message({
                    message: '正在通话...',
                    type: 'success'
                });
                if(_this.kefuPeerId==""||_this.localStream==null){
                    return;
                }

                var call = _this.peer.call(_this.kefuPeerId, _this.localStream);
                call.on('stream', function(remoteStream) {
                    console.log(remoteStream);
                    remoteVideo.srcObject = remoteStream;
                    remoteVideo.autoplay = true;
                });
                call.on('close', function() {
                    console.log("call close");
                    _this.loading.close();
                });
                call.on('error', function(err) {
                    console.log(err);
                    _this.loading.close();
                });

            },
            getExtendInfo:function(){
                var _this=this;
                var extra=getQuery("extra");
                if(extra==""){
                    return;
                }

                try{
                    var extraString=b64ToUtf8(extra);
                    if(_this.getCache("extra")==extraString){
                        return;
                    }
                    var extra=JSON.parse(extraString);
                    if (typeof extra=="string"){
                        extra=JSON.parse(extra);
                    }

                    for(var key in extra){
                        if(extra[key]==""){
                            extra[key]="无";
                        }
                        if(key=="visitorProduct"){
                            _this.messageContent="product["+JSON.stringify(extra[key])+"]";
                            _this.chatToUser();
                            _this.setCache("extra",extraString);
                        };
                    }
                }catch (e) {
                }
            },
            sendAjax:function(url,method,params,callback){
                let _this=this;
                $.ajax({
                    type: method,
                    url: BaseURL + url,
                    data:params,
                    headers:{
                        "lang":getQuery("lang"),
                        "token": localStorage.getItem("token")
                    },
                    error:function(res){
                        var data=JSON.parse(res.responseText);
                        console.log(data);
                        if(data.code!=200){
                            _this.$message({
                                message: data.msg,
                                type: 'error'
                            });
                        }
                    },
                    success: function(data) {
                        if(data.code!=200){
                            _this.$message({
                                message: data.msg,
                                type: 'error'
                            });
                        }else if(data.result!=null){
                            callback(data.result);
                        }else{
                            callback(data);
                        }
                    }
                });
            },
            showTitle:function(title){
                this.chatTitle=title;
                $(".chatBox").append("<div class=\"chatTime\"><span>"+title+"</span></div>");
                this.scrollBottom();
            },
            
            startRecoder:function(e){
                if(this.recorder){
                    this.recorder.destroy();
                    this.recorder=null;
                }
                var _this=this;
                Recorder.getPermission().then(function() {
                    _this.recorder = new Recorder();
                    _this.recorderAudio = document.querySelector('#audio');
                    _this.recorder.start();
                    _this.recorder.onprogress = function (params) {
                        _this.recoderSecond = parseInt(params.duration);
                    }
                    this.talkBtnText = "松开 结束";
                }, function(error){
                    _this.$message({
                        message: "请允许录音权限,以及浏览器限制非HTTPS下无法使用",
                        type: 'error'
                    });
                    return;
                });
                e.preventDefault();
            },
            stopRecoder:function(e){
                if(!this.recorder){
                    return;
                }
                var blob=this.recorder.getWAVBlob();
                this.recorderAudio.src = URL.createObjectURL(blob);
                this.recorderAudio.controls = true;
                this.talkBtnText="按住 说话";
                this.recorderEnd=true;
                e.preventDefault();
            },
            sendRecoder:function(){
                if(!this.recorder){
                    return;
                }

                var blob=this.recorder.getWAVBlob();
                var formdata = new FormData(); 
                formdata.append("realfile", blob); 
                var _this=this;
                this.loading = this.$loading({
                    lock: true,
                    text: '正在发送',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                $.ajax({
                    url: BaseURL + "/2/uploadAudio",
                    type: 'post',
                    processData: false,
                    contentType: false,
                    data: formdata,
                    dataType: 'JSON',
                    mimeType: "multipart/form-data",
                    success: function (res) {
                        _this.loading.close();
                        if(res.code!=200){
                            _this.$message({
                                message: res.msg,
                                type: 'error'
                            });
                        }else{
                            _this.cancelRecoder();
                            _this.messageContent+='audio[' + res.result.path + ']';
                            _this.chatToUser();
                        }
                    }
                })

            },
            cancelRecoder:function(){
                this.audioDialog=false;
                if(!this.recorder){
                    return;
                }
                this.recorder.destroy();
                this.recorder=null;
                this.recoderSecond=0;
            },
            recoderFormat:function(percentage){
                return percentage+"s";
            },
            openNewWindow:function(){
                var features = "height=580, width=400, top=10, left=500, toolbar=no, menubar=no,scrollbars=no,resizable=no, location=no, status=no";  
                var me = window.open(location.href, "newW", features);
            },
            
            checkTimeout:function(){
                var _this=this;
                this.timeoutTimer=setInterval(function(){
                    if (Date.now() - _this.currentActiveTime >= _this.timeoutLongTime) {
                        _this.comment=true;
                        console.log("长时间无操作");
                        if(_this.socket!=null){
                            _this.reconnectDialog=true;
                            _this.showTitle(GOFLY_LANG[LANG]['autoclosemes']);
                            _this.socket.close();
                            _this.socket=null;
                        }
                    }
                },55000);
            },
            closeTimeoutTimer:function(){
                clearInterval(this.timeoutTimer);
            },
            cleanAllTimeout:function(){
                for(var i in this.allTimeouter){
                    clearTimeout(this.allTimeouter[i]);
                }
            },
            loadMoreMessages:function(){
                var _this=this;
                var pagesize=5;
                
                
                
                if(_this.loadMoreDisable){
                    return;
                }
                var moreMessage=GOFLY_LANG[LANG]['moremessage'];
                this.flyLang.moremessage=this.flyLang.loading;
                this.loadMoreDisable=true;
                var hasUnread=false;
                let entId = ENT_ID
                if(!this.getCache('isRebot')) {
                  entId = '4'
                }
                $.ajax({
                  type:"get",
                  url:BaseURL + "/2/messages_page?pagesize="+pagesize + "&ent_id="+ entId + "&page=" + this.currentPage + "&visitor_id=" + _this.visitor.visitor_id,
                  success: function(data){
                    let result = data.result
                    var len=result.list.length;
                    if(result.list.length!=0){
                        if(len<pagesize){
                            _this.showLoadMore=false;
                        }else{
                            _this.showLoadMore=true;
                        }

                        let msgList=result.list;
                        for(var i=0;i<msgList.length;i++) {
                            let visitorMes = msgList[i];
                            let content = {}
                            if (visitorMes["mes_type"] == "kefu") {
                                content.is_kefu = false;
                                content.content = replaceSpecialTag(visitorMes["content"]);
                            } else {
                                content.is_kefu = true;
                                content.content = replaceContent(visitorMes["content"]);
                            }
                            if (visitorMes["read_status"] == "read") {
                                content.read_status = GOFLY_LANG[LANG].read;
                            } else {
                                content.read_status = GOFLY_LANG[LANG].unread;
                                if(i==0){
                                    hasUnread=true;
                                    _this.haveUnreadMessage=true;
                                }
                            }
                            content.avator = visitorMes["avator"];
                            content.name = visitorMes["name"];
                            content.msg_id = visitorMes["msg_id"];
                            content.time = visitorMes["time"];
                            _this.msgList.unshift(content);
                            
                        }
                    }else{
                        _this.showLoadMore=false;
                    }
                    if(_this.currentPage==1){
                        _this.showWechatTip();
                        _this.scrollBottom();
                        _this.getTopQuestion();
                        
                        _this.getNotice();
                    }

                    _this.currentPage++;
                    _this.flyLang.moremessage=moreMessage;
                    _this.loadMoreDisable=false;
                  }
                });
            },
            showWechatTip:function(){
                if(!GOFLY_CONFIG.SHOW_WECHAT){
                    return;
                }
                var child = '<div class="wechatTip">';
                child += '<img style="width:80px; margin:10px;" src="'+GOFLY_CONFIG.WECHAT_QR_URL+'?snow_id=' + this.visitor.visitor_id + '&id_type=visitor">';
                child += '扫描左侧二维码可直接用微信登录。<br>可防止更换浏览器丢失消息、收不到回复。<br>并可接收回复通知</div>';
                $(".chatBox").append(child);
            },
            sendComment:function(tagName){
                var _this=this;
                this.sendAjax("/2/comment","post",{
                    tag_name:tagName,
                    kefu_name:this.visitor.to_id,
                    ent_id:ENT_ID,
                    visitor_id:_this.visitor.visitor_id},function(result){});
            },
            
            formatTime:function(time) {
                
                
                
                
                
                
                
                
                
                
                return time;
            },
            getVersion:function(){
                if(IS_TRY=="false"){
                    return;
                }
                this.$alert('当前为试用版本，请点击底部链接获取授权', '警告！', {
                    confirmButtonText: '确定',
                });
            },
            selectLang:function(lang){
                var url=changeURLPar(document.URL,"lang",lang);
                document.location.href=url;
            },
            
            focusHandle(){
                clearFlashTitle();
                window.location.reload();
            },
            visitorPageHeight(){
                
                if(isWeiXin()){
                    $("body").css("height","100vh");
                }else{
                    $("body").css("height",document.documentElement.clientHeight+"px");
                }
                
            }
        },
        mounted:function() {
            var _this=this;
            document.addEventListener('paste', this.onPasteUpload);
            document.addEventListener('scroll',this.textareaBlur);
            this.inputNextText = debounce(this.inputNextText, 1000)
            window.changeRebot = this.change
            window.addEventListener('message',function(e){
                var msg=e.data;
                if(msg.module&&msg.module=="locationPicker"){
                    _this.qqMap=false;
                    console.log('location', msg);
                    var address={
                        "title":msg.poiaddress,
                        "price":msg.poiname,
                        "img":"/static/images/qqmap.png",
                        "url":"https://apis.map.qq.com/tools/poimarker?type=0&marker=coord:"+msg.latlng.lat+","+msg.latlng.lng+"&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&referer=myapp"
                    };
                    _this.messageContent="product["+JSON.stringify(address)+"]";
                    _this.chatToUser();
                }
                if(msg.type=="inputing_message"){
                    _this.sendInputingStrNow(msg.content);
                }
                if(msg.type=="send_message"){
                    _this.messageContent=msg.content;
                    _this.chatToUser();
                }
            });
        },
        created: function () {
            this.init();
            this.getUserInfo();
        }
    })
</script>
</html>
